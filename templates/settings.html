<!DOCTYPE html>
<html lang="en" data-theme="{{ settings.get('theme', 'dark') }}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings — Sclera</title>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/onboarding.css') }}">
</head>

<body>
    <div class="dashboard-layout">
        {% include '_topnav.html' %}

        <main class="main-content">
            <div class="content-header">
                <h1>Settings</h1>
                <p>Customize your StudyOS experience</p>
            </div>

            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            {% for category, message in messages %}
            <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
            {% endif %}
            {% endwith %}

            <div class="academic-split">
                <!-- LEFT PANEL - Main Settings -->
                <div class="syllabus-panel">

                    <!-- APPEARANCE ISLAND -->
                    <div class="study-island">
                        <div class="study-island-header">
                            <h3>Appearance</h3>
                        </div>
                        <form method="POST" action="{{ url_for('settings') }}">
                            <input type="hidden" name="action" value="general">

                            <div class="form-group">
                                <label>Theme</label>
                                <div class="radio-group" style="display:flex;gap:16px;margin-top:8px;">
                                    <label class="radio-label"
                                        style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                                        <input type="radio" name="theme" value="dark" {% if settings.get('theme', 'dark'
                                            )=='dark' %}checked{% endif %} style="cursor:pointer;">
                                        <span>Dark Mode</span>
                                    </label>
                                    <label class="radio-label"
                                        style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                                        <input type="radio" name="theme" value="light" {% if
                                            settings.get('theme')=='light' %}checked{% endif %} style="cursor:pointer;">
                                        <span>Light Mode</span>
                                    </label>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary" style="margin-top:16px;">Save
                                Appearance</button>
                        </form>
                    </div>

                    <!-- NOTIFICATIONS ISLAND -->
                    <div class="study-island">
                        <div class="study-island-header">
                            <h3>Notifications</h3>
                        </div>
                        <form method="POST" action="{{ url_for('settings') }}">
                            <input type="hidden" name="action" value="general">

                            <div class="form-group checkbox-group" style="display:flex;align-items:center;gap:12px;">
                                <input type="checkbox" name="email_notifications" id="email_notifications" {% if
                                    settings.get('email_notifications') %}checked{% endif %}
                                    style="width:18px;height:18px;cursor:pointer;">
                                <label for="email_notifications" style="cursor:pointer;">
                                    Email Notifications
                                </label>
                            </div>
                            <p class="form-hint" style="color:var(--text-muted);font-size:13px;margin-top:8px;">
                                Receive email updates about your progress and goals
                            </p>
                            <button type="submit" class="btn btn-primary" style="margin-top:16px;">Save
                                Notifications</button>
                        </form>
                    </div>

                    <!-- PROFILE ISLAND -->
                    <div class="study-island">
                        <div class="study-island-header">
                            <h3>Profile Information</h3>
                        </div>
                        <form method="POST" action="{{ url_for('settings') }}">
                            <input type="hidden" name="action" value="account">

                            <div class="form-group" style="margin-bottom:16px;">
                                <label for="name">Display Name</label>
                                <input type="text" name="name" id="name" value="{{ user.get('name', '') }}"
                                    placeholder="Your name" style="width:100%;margin-top:8px;">
                            </div>

                            <div class="info-group" style="margin-bottom:16px;">
                                <label>Email</label>
                                <p style="color:var(--text-muted);margin-top:4px;">{{ user.get('email', 'Not set') }}
                                </p>
                            </div>

                            <div class="info-group" style="margin-bottom:16px;">
                                <label>Current Purpose</label>
                                <p style="color:var(--text-muted);margin-top:4px;text-transform:capitalize;">
                                    {{ user.get('purpose', 'Not set').replace('_', ' ') }}
                                </p>
                            </div>

                            <div class="info-group" style="margin-bottom:16px;">
                                <label>Current Academic Configuration</label>
                                {% if user.get('purpose') == 'school' %}
                                    {% set school_data = user.get('school', {}) %}
                                    {% if school_data %}
                                        <p style="color:var(--text-muted);margin-top:4px;">
                                            <strong>Board:</strong> {{ school_data.get('board', 'Not set') }}<br>
                                            <strong>Grade:</strong> {{ school_data.get('grade', 'Not set') }}<br>
                                            {% if school_data.get('subject_combination') %}
                                                <strong>Subject Combination:</strong> {{ school_data.get('subject_combination') }}<br>
                                            {% endif %}
                                        </p>
                                    {% else %}
                                        <p style="color:var(--text-muted);margin-top:4px;">Not configured</p>
                                    {% endif %}
                                {% elif user.get('purpose') == 'exam_prep' %}
                                    {% set exam_data = user.get('exam', {}) %}
                                    {% if exam_data %}
                                        <p style="color:var(--text-muted);margin-top:4px;">
                                            <strong>Exam Type:</strong> {{ exam_data.get('type', 'Not set') }}
                                        </p>
                                    {% else %}
                                        <p style="color:var(--text-muted);margin-top:4px;">Not configured</p>
                                    {% endif %}
                                {% else %}
                                    <p style="color:var(--text-muted);margin-top:4px;">Not configured</p>
                                {% endif %}
                            </div>

                            <!-- PUBLIC PROFILE CONSENT -->
                            <div class="form-group" style="margin-bottom:16px;">
                                <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                                    <input type="checkbox" name="has_public_profile" value="true" 
                                        {% if user.get('has_public_profile', False) %}checked{% endif %} 
                                        style="cursor:pointer;"
                                        onchange="togglePublicProfileSettings(this.checked)">
                                    <span>Make my profile public</span>
                                </label>
                                <p style="color:var(--text-muted);font-size:0.875rem;margin-top:4px;">
                                    When enabled, other users can view your academic profile when searching for students. 
                                    You can control what information is visible below.
                                </p>
                            </div>

                            <!-- PRIVACY SETTINGS (shown only when public profile is enabled) -->
                            <div id="privacySettings" style="{% if not user.get('has_public_profile', False) %}display:none;{% else %}display:block;{% endif %}margin-bottom:16px;">
                                <div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:16px;margin-top:8px;">
                                    <h4 style="margin-bottom:12px;color:var(--text-primary);font-weight:500;">Profile Visibility Settings</h4>
                                    <p style="color:var(--text-muted);font-size:0.875rem;margin-bottom:16px;">
                                        Choose what information to display in your public profile:
                                    </p>
                                    
                                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                                        <div>
                                            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;margin-bottom:8px;">
                                                <input type="checkbox" name="visibility_name" value="true" 
                                                    {% if user.get('profile_visibility', {}).get('name', True) %}checked{% endif %} 
                                                    style="cursor:pointer;">
                                                <span>Show Name</span>
                                            </label>
                                            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;margin-bottom:8px;">
                                                <input type="checkbox" name="visibility_purpose" value="true" 
                                                    {% if user.get('profile_visibility', {}).get('purpose', True) %}checked{% endif %} 
                                                    style="cursor:pointer;">
                                                <span>Show Academic Purpose</span>
                                            </label>
                                        </div>
                                        
                                        <div>
                                            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;margin-bottom:8px;">
                                                <input type="checkbox" name="visibility_academic_summary" value="true" 
                                                    {% if user.get('profile_visibility', {}).get('academic_summary', True) %}checked{% endif %} 
                                                    style="cursor:pointer;">
                                                <span>Show Academic Summary</span>
                                            </label>
                                            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;margin-bottom:8px;">
                                                <input type="checkbox" name="visibility_about" value="true" 
                                                    {% if user.get('profile_visibility', {}).get('about', True) %}checked{% endif %} 
                                                    style="cursor:pointer;">
                                                <span>Show About/Bio</span>
                                            </label>
                                            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;margin-bottom:8px;">
                                                <input type="checkbox" name="visibility_grade" value="true" 
                                                    {% if user.get('profile_visibility', {}).get('grade', True) %}checked{% endif %} 
                                                    style="cursor:pointer;">
                                                <span>Show Grade</span>
                                            </label>
                                        </div>
                                        
                                        <div>
                                            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;margin-bottom:8px;">
                                                <input type="checkbox" name="visibility_school" value="true" 
                                                    {% if user.get('profile_visibility', {}).get('school', True) %}checked{% endif %} 
                                                    style="cursor:pointer;">
                                                <span>Show School</span>
                                            </label>
                                            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;margin-bottom:8px;">
                                                <input type="checkbox" name="visibility_skills" value="true" 
                                                    {% if user.get('profile_visibility', {}).get('skills', True) %}checked{% endif %} 
                                                    style="cursor:pointer;">
                                                <span>Show Skills & Interests</span>
                                            </label>
                                        </div>
                                        
                                        <div>
                                            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;margin-bottom:8px;">
                                                <input type="checkbox" name="visibility_subjects" value="true" 
                                                    {% if user.get('profile_visibility', {}).get('subjects', True) %}checked{% endif %} 
                                                    style="cursor:pointer;">
                                                <span>Show Subjects</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- USER UID SECTION -->
                            <div class="form-group" style="margin-bottom:16px;">
                                <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                                    <span class="material-symbols-outlined" style="color:var(--accent);">tag</span>
                                    <span>Your User ID (UID)</span>
                                </label>
                                <div style="display:flex;align-items:center;gap:8px;margin-top:8px;">
                                    <input type="text" value="{{ user.uid }}" readonly 
                                           style="flex:1;padding:8px;background:var(--surface);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);font-family:monospace;">
                                    <button type="button" onclick="copyUid()" 
                                            style="padding:8px 12px;background:var(--accent);color:var(--bg-primary);border:none;border-radius:6px;cursor:pointer;font-size:0.875rem;">
                                        <span class="material-symbols-outlined" style="font-size:16px;vertical-align:middle;">content_copy</span>
                                        Copy
                                    </button>
                                </div>
                                <p style="color:var(--text-muted);font-size:0.875rem;margin-top:4px;">
                                    Share your UID with friends so they can find and connect with you directly.
                                </p>
                            </div>

                            <button type="submit" class="btn btn-primary">Update Profile</button>
                        </form>
                    </div>
                </div>

                <!-- RIGHT PANEL - Academic Configuration -->
                <div class="study-tools-panel">

                    <!-- ACADEMIC CONFIG ISLAND -->
                    <div class="study-island" style="border:2px solid var(--accent);">
                        <div class="study-island-header">
                            <h3>Academic Configuration</h3>
                            <span style="font-size:12px;color:var(--accent);">⚠️ Destructive</span>
                        </div>

                        <div class="warning-box"
                            style="background:rgba(var(--accent-rgb),0.1);border-left:4px solid var(--accent);padding:16px;margin-bottom:20px;border-radius:8px;">
                            <p style="margin:0;font-size:14px;">
                                <strong>Warning:</strong> Changing your academic configuration will permanently delete
                                all your current progress, including:
                            </p>
                            <ul style="margin:8px 0 0 20px;font-size:13px;color:var(--text-muted);">
                                <li>All chapter completion data</li>
                                <li>Exam results and statistics</li>
                                <li>Study time tracking</li>
                                <li>Syllabus exclusions</li>
                            </ul>
                            <p style="margin:8px 0 0;font-size:13px;color:var(--text-muted);">
                                This action cannot be undone.
                            </p>
                        </div>

                        <form method="POST" action="{{ url_for('settings') }}" id="academic-form">
                            <input type="hidden" name="action" value="academic">

                            <div class="form-group" style="margin-bottom:16px;">
                                <label for="purpose">Study Purpose</label>
                                <select name="purpose" id="purpose" required style="width:100%;margin-top:8px;"
                                    onchange="updateAcademicFields()">
                                    <option value="">Select purpose...</option>
                                    <option value="school" {% if user.get('purpose')=='school' %}selected{% endif %}>
                                        School
                                    </option>
                                    <option value="exam_prep" {% if user.get('purpose')=='exam_prep' %}selected{% endif %}>
                                        Competitive Exam
                                    </option>
                                </select>
                            </div>

                            <!-- Fields for School -->
                            <div id="school-fields" class="academic-fields" style="display:none;">
                                <div class="form-group" style="margin-bottom:16px;">
                                    <label for="board">Board</label>
                                    <select name="board" id="board" style="width:100%;margin-top:8px;" onchange="updateGradeFields()">
                                        {% for board in available_boards %}
                                        <option value="{{ board }}" {% if (user.get('school') or
                                            {}).get('board')==board %}selected{% endif %}>
                                            {{ board }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="form-group" style="margin-bottom:16px;">
                                    <label for="grade">Grade</label>
                                    <select name="grade" id="grade" style="width:100%;margin-top:8px;" onchange="updateSubjectCombination()">
                                        {% for grade in available_grades %}
                                        <option value="{{ grade }}" {% if (user.get('school') or
                                            {}).get('grade')==grade %}selected{% endif %}>
                                            Grade {{ grade }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="form-group" style="margin-bottom:16px;display:none;" id="subject_combination_group">
                                    <label for="subject_combination">Subject Combination (for Grades 11-12)</label>
                                    <select name="subject_combination" id="subject_combination" style="width:100%;margin-top:8px;">
                                        <option value="">Select your subject combination</option>
                                        <option value="PCM" {% if (user.get('school') or {}).get('subject_combination')=='PCM' %}selected{% endif %}>Physics, Chemistry, Mathematics</option>
                                        <option value="PCB" {% if (user.get('school') or {}).get('subject_combination')=='PCB' %}selected{% endif %}>Physics, Chemistry, Biology</option>
                                        <option value="PCMB" {% if (user.get('school') or {}).get('subject_combination')=='PCMB' %}selected{% endif %}>Physics, Chemistry, Mathematics, Biology</option>
                                        <option value="COMMAT" {% if (user.get('school') or {}).get('subject_combination')=='COMMAT' %}selected{% endif %}>Accountancy, Business Studies, Economics</option>
                                        <option value="COM" {% if (user.get('school') or {}).get('subject_combination')=='COM' %}selected{% endif %}>Computer Applications, Informatics Practices</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Fields for Exam -->
                            <div id="exam-fields" class="academic-fields" style="display:none;">
                                <div class="form-group" style="margin-bottom:16px;">
                                    <label for="exam_type">Exam Type</label>
                                    <select name="exam_type" id="exam_type" style="width:100%;margin-top:8px;">
                                        {% for exam in available_exams %}
                                        <option value="{{ exam }}" {% if (user.get('exam') or {}).get('type')==exam
                                            %}selected{% endif %}>
                                            {{ exam }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>


                            <div class="form-group checkbox-group"
                                style="display:flex;align-items:center;gap:12px;margin-top:24px;padding:16px;background:var(--bg-tertiary);border-radius:8px;">
                                <input type="checkbox" name="confirm_delete" id="confirm_delete" required
                                    style="width:18px;height:18px;cursor:pointer;">
                                <label for="confirm_delete" style="cursor:pointer;font-size:14px;">
                                    I understand that changing these settings will <strong>delete all my
                                        progress</strong> and cannot be undone.
                                </label>
                            </div>

                            <button type="submit" class="btn btn-primary"
                                style="margin-top:16px;width:100%;background:var(--accent);">
                                Update Academic Configuration
                            </button>
                        </form>
                    </div>

                    <!-- QUICK LINKS ISLAND -->
                    <div class="study-island">
                        <div class="study-island-header">
                            <h3>Quick Links</h3>
                        </div>
                        <div style="display:flex;flex-direction:column;gap:12px;">
                            <a href="{{ url_for('profile_resume') }}" class="btn btn-secondary"
                                style="text-align:center;">
                                View Profile
                            </a>
                            <a href="{{ url_for('profile_edit') }}" class="btn btn-secondary"
                                style="text-align:center;">
                                Edit Full Profile
                            </a>
                            <a href="{{ url_for('contact') }}" class="btn btn-secondary" style="text-align:center;">
                                Contact Support
                            </a>
                        </div>
                    </div>

                    <!-- TUTORIAL SECTION -->
                    <div class="study-island">
                        <div class="study-island-header">
                            <h3>Tutorial & Help</h3>
                        </div>

                        <div class="tutorial-section">
                            <!-- Video Tutorial Placeholder -->
                            <div class="tutorial-video-placeholder">
                                <span class="material-symbols-outlined">play_circle</span>
                                <p>Video tutorial coming soon</p>
                            </div>

                            <!-- Tutorial Actions -->
                            <div class="tutorial-actions">
                                <button class="tutorial-btn" onclick="restartTutorial()">
                                    <span class="material-symbols-outlined">replay</span>
                                    Restart Dashboard Tutorial
                                </button>
                                <a href="{{ url_for('docs_dashboard') }}" class="tutorial-btn">
                                    <span class="material-symbols-outlined">help</span>
                                    View Documentation
                                </a>
                                <a href="{{ url_for('contact') }}" class="tutorial-btn">
                                    <span class="material-symbols-outlined">contact_support</span>
                                    Contact Support
                                </a>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </main>
    </div>

    <script>
        function togglePublicProfileSettings(isChecked) {
            const privacySettings = document.getElementById('privacySettings');
            if (privacySettings) {
                if (isChecked) {
                    privacySettings.style.display = 'block';
                } else {
                    privacySettings.style.display = 'none';
                }
            }
        }

        function copyUid() {
            const uidInput = document.querySelector('input[value="{{ user.uid }}"]');
            if (uidInput) {
                uidInput.select();
                uidInput.setSelectionRange(0, 99999);
                
                try {
                    navigator.clipboard.writeText(uidInput.value);
                    showToast('UID copied to clipboard!', 'success');
                } catch (err) {
                    console.error('Failed to copy UID:', err);
                    showToast('Failed to copy UID', 'error');
                }
            }
        }

        function updateAcademicFields() {
            const purpose = document.getElementById('purpose').value;

            // Hide all field groups
            document.querySelectorAll('.academic-fields').forEach(el => {
                el.style.display = 'none';
            });

            // Show relevant fields
            if (purpose === 'school') {
                document.getElementById('school-fields').style.display = 'block';
                // Initialize grade and subject combination visibility
                updateGradeFields();
            } else if (purpose === 'exam_prep') {
                document.getElementById('exam-fields').style.display = 'block';
            }
        }

        function updateGradeFields() {
            const board = document.getElementById('board').value;
            const grade = document.getElementById('grade').value;
            const subjectComboGroup = document.getElementById('subject_combination_group');
            
            // Show subject combination only for CBSE grades 11-12
            if (board === 'CBSE' && (grade === '11' || grade === '12')) {
                subjectComboGroup.style.display = 'block';
            } else {
                subjectComboGroup.style.display = 'none';
            }
        }

        function updateSubjectCombination() {
            updateGradeFields();
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', updateAcademicFields);

        // Theme (keep consistent with other dashboards)
        (function () {
            const root = document.documentElement;
            const toggle = document.getElementById("themeToggle");

            const serverTheme = "{{ settings.get('theme', '') }}";
            if (serverTheme) {
                root.setAttribute("data-theme", serverTheme);
                localStorage.setItem("sclera-theme", serverTheme);
            }

            const savedTheme = localStorage.getItem("sclera-theme");
            if (savedTheme) {
                root.setAttribute("data-theme", savedTheme);
            }

            if (toggle) {
                toggle.addEventListener("click", () => {
                    const next =
                        root.getAttribute("data-theme") === "dark"
                            ? "light"
                            : "dark";

                    root.setAttribute("data-theme", next);
                    localStorage.setItem("sclera-theme", next);
                });
            }
        })();

        // Restart Tutorial Function
        function restartTutorial() {
            // Clear tutorial completion status
            localStorage.removeItem('sclera_tutorial_completed');
            localStorage.removeItem('sclera_tutorial_skipped');

            // Redirect to dashboard with tutorial trigger
            window.location.href = '{{ url_for("profile_dashboard") }}?tutorial=start';
        }
    </script>
</body>

</html>