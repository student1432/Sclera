<!DOCTYPE html>
<html lang="en" data-theme="{{ settings.get('theme', 'dark') }}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home — Sclera</title>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@100..700,0..1&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="dashboard-layout">
        <!-- TOPNAV -->
        {% include '_topnav.html' %}

        <!-- MAIN -->
        <main class="main-content">
            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            {% for category, message in messages %}
            <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
            {% endif %}
            {% endwith %}

            <div class="dashboard-grid">

                <!-- 1. COMPACT ACADEMIC ISLAND -->
                <a href="{{ url_for('academic_dashboard') }}" class="island island-academic" style="text-decoration:none;">
                    <h3>Academic</h3>
                    <p>Syllabus &amp; Progress</p>
                    <div class="academic-content">
                        <div class="island-chart">
                            <canvas id="academicDonut"></canvas>
                            <div class="chart-center-text">{{ overall_progress }}%</div>
                        </div>
                        <div class="academic-legend">
                            <div class="legend-item">
                                <span class="legend-label">Done:</span>
                                <span class="legend-value">{{ completed_chapters }}</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-label">Total:</span>
                                <span class="legend-value">{{ total_chapters }}</span>
                            </div>
                        </div>
                    </div>
                </a>

                <!-- 2. STREAK ISLAND -->
                <div class="island streak-island">
                    <div class="streak-icon">
                        <span class="material-symbols-outlined">local_fire_department</span>
                    </div>
                    <div class="streak-info">
                        <h4>Daily Streak</h4>
                        <div class="streak-val">{{ streak }} Days</div>
                    </div>
                </div>

                <!-- 3. PROFILE ISLAND (Compact) -->
                <a href="{{ url_for('profile_resume') }}" class="island" style="text-decoration:none;">
                    <h3>Profile</h3>
                    <div class="profile-content-compact">
                        {% if profile_picture %}
                        <img src="{{ url_for('serve_profile_picture', filename=profile_picture.split('/')[1]) }}" alt="PFP" class="profile-pic-small">
                        {% else %}
                        <div class="profile-pic-small-placeholder">
                            <span class="material-symbols-outlined">person</span>
                        </div>
                        {% endif %}
                        <div class="profile-meta-compact">
                            <p class="name">{{ name }}</p>
                            <p class="purpose">{{ purpose_display }}</p>
                        </div>
                    </div>
                </a>

                <!-- 4. CALENDAR WIDGET ISLAND -->
                <a href="{{ url_for('calendar_dashboard') }}" class="island island-calendar-widget" style="text-decoration:none;">
                    <h3>Calendar</h3>
                    <p>Upcoming Deadlines</p>
                    <div class="mini-calendar-events">
                        {% set recent_events = calendar_events | sort(attribute='start') %}
                        {% for event in recent_events[:5] %}
                        <div class="mini-event-item">
                            <div class="mini-event-dot dot-{{ event.type }}"></div>
                            <div class="event-details">
                                <div class="event-title">{{ event.title }}</div>
                                <div class="event-date">{{ event.start }}</div>
                            </div>
                            {% if event.completed %}
                            <span class="material-symbols-outlined success-icon">check_circle</span>
                            {% endif %}
                        </div>
                        {% else %}
                        <div class="empty-state-mini">
                            <span class="material-symbols-outlined">event_busy</span>
                            <p>No upcoming events</p>
                        </div>
                        {% endfor %}
                    </div>
                    <span class="cta-link">View full calendar →</span>
                </a>

                <!-- 5. PERFORMANCE ISLAND -->
                <div class="island">
                    <h3>Performance</h3>
                    {% if last_exam %}
                    <div class="performance-metrics">
                        <div class="perf-item">
                            <div class="perf-label-row">
                                <span>Average Score</span>
                                <span class="perf-val">{{ avg_performance }}%</span>
                            </div>
                            <div class="perf-bar-container">
                                <div class="perf-bar-fill" style="width: {{ avg_performance }}%; background: var(--info);"></div>
                            </div>
                        </div>

                        <div class="perf-item">
                            <div class="perf-label-row">
                                <span>Last Exam</span>
                                <span class="perf-val">{{ last_exam.pct }}%</span>
                            </div>
                            <div class="perf-bar-container">
                                <div class="perf-bar-fill" style="width: {{ last_exam.pct }}%; background: var(--success);"></div>
                            </div>
                            <div class="perf-meta">{{ last_exam.subject }}</div>
                        </div>

                        <div class="perf-item">
                            <div class="perf-label-row">
                                <span>Highest Score</span>
                                <span class="perf-val">{{ highest_exam.pct }}%</span>
                            </div>
                            <div class="perf-bar-container">
                                <div class="perf-bar-fill" style="width: {{ highest_exam.pct }}%; background: var(--warning);"></div>
                            </div>
                            <div class="perf-meta">{{ highest_exam.subject }}</div>
                        </div>
                    </div>
                    {% else %}
                    <div class="empty-state-mini">
                        <span class="material-symbols-outlined">analytics</span>
                        <p>No exam data available yet</p>
                    </div>
                    {% endif %}
                </div>

                <!-- 6. STATS ISLAND -->
                <div class="island">
                    <h3>Completion Stats</h3>
                    <div class="stats-island-grid">
                        <div class="stat-box-small">
                            <span class="val">{{ completed_goals }}/{{ total_goals }}</span>
                            <span class="lab">Goals</span>
                        </div>
                        <div class="stat-box-small">
                            <span class="val">{{ completed_tasks }}/{{ total_tasks }}</span>
                            <span class="lab">Tasks</span>
                        </div>
                        <div class="stat-box-small">
                            <span class="val">{{ completed_assignments }}/{{ total_assignments }}</span>
                            <span class="lab">Assignments</span>
                        </div>
                        <div class="stat-box-small">
                            <span class="val">{{ completed_chapters }}</span>
                            <span class="lab">Chapters</span>
                        </div>
                    </div>
                </div>

                <!-- 7. STUDY TIME GRAPH -->
                <div class="island" style="grid-column: span 2;">
                    <h3>Study Time (Last 7 Days)</h3>
                    <div class="study-time-container">
                        <canvas id="studyTimeChart"></canvas>
                    </div>
                </div>

                <!-- 8. QUICK TODO ISLAND -->
                <div class="island">
                    <h3>Quick Access TODO</h3>
                    <div class="quick-todo-container">
                        <div class="todo-input-row">
                            <input type="text" id="newTodoInput" placeholder="New task..." aria-label="New todo task">
                            <button class="btn btn-secondary" onclick="addTodo()" title="Add Task">+</button>
                        </div>
                        <div class="mini-todo-list" id="todoList">
                            <!-- JS populated -->
                        </div>
                    </div>
                </div>

            </div>

        </main>
    </div>

    <script>
        // Charts Global Configuration
        Chart.defaults.color = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary');
        Chart.defaults.font.family = "'Inter', sans-serif";

        // ACADEMIC DONUT
        let academicChart = null;
        function updateAcademicChart() {
            const canvas = document.getElementById('academicDonut');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const progress = {{ overall_progress }};
            const rootStyles = getComputedStyle(document.documentElement);
            const progressFill = rootStyles.getPropertyValue('--progress-fill').trim() || '#ffffff';
            const progressTrack = rootStyles.getPropertyValue('--progress-track').trim() || '#27272a';
            
            if (academicChart) academicChart.destroy();
            academicChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [progress, Math.max(1, 100 - progress)],
                        backgroundColor: [progressFill, progressTrack],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '80%',
                    animation: {
                        animateRotate: true,
                        duration: 1500,
                        easing: 'easeOutQuart'
                    },
                    plugins: { legend: { display: false }, tooltip: { enabled: false } }
                }
            });
        }

        // STUDY TIME CHART
        function initStudyChart() {
            const canvas = document.getElementById('studyTimeChart');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const data = {{ study_stats | tojson | safe }};

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.day),
                    datasets: [{
                        label: 'Hours Studied',
                        data: data.map(d => d.hours),
                        backgroundColor: '#3b82f6',
                        borderRadius: 6,
                        hoverBackgroundColor: '#60a5fa'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255,255,255,0.05)', drawBorder: false },
                            ticks: { font: { size: 10 } }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { font: { size: 10 } }
                        }
                    },
                    plugins: { legend: { display: false } },
                    animation: { duration: 1000, easing: 'easeOutBack' }
                }
            });
        }

        // QUICK TODO LOGIC
        async function fetchTodos() {
            try {
                const res = await fetch('/api/todos');
                if (!res.ok) throw new Error('Failed to fetch');
                const todos = await res.json();
                renderTodos(todos);
            } catch (err) {
                console.error(err);
            }
        }

        function renderTodos(todos) {
            const list = document.getElementById('todoList');
            list.innerHTML = '';

            if (todos.length === 0) {
                list.innerHTML = '<p class="empty-state-small">No tasks today</p>';
                return;
            }

            todos.forEach(todo => {
                const div = document.createElement('div');
                div.className = `mini-todo-item ${todo.completed ? 'done' : ''}`;
                div.innerHTML = `
                    <input type="checkbox" ${todo.completed ? 'checked' : ''} onchange="toggleTodo('${todo.id}')">
                    <span>${todo.text}</span>
                    <span class="material-symbols-outlined delete-btn-small" onclick="deleteTodo('${todo.id}')">delete</span>
                `;
                list.appendChild(div);
            });
        }

        async function addTodo() {
            const input = document.getElementById('newTodoInput');
            const text = input.value.trim();
            if (!text) return;

            try {
                const res = await fetch('/api/todos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'add', text })
                });
                const data = await res.json();
                input.value = '';
                renderTodos(data.todos);
            } catch (err) {
                alert('Failed to add task');
            }
        }

        async function toggleTodo(id) {
            try {
                const res = await fetch('/api/todos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'toggle', id })
                });
                const data = await res.json();
                renderTodos(data.todos);
            } catch (err) {
                console.error(err);
            }
        }

        async function deleteTodo(id) {
            if (!confirm('Delete this task?')) return;

            // Optimistic UI removal
            const items = document.querySelectorAll('.mini-todo-item');
            items.forEach(item => {
                if (item.querySelector(`span[onclick*="${id}"]`) || item.querySelector(`input[onchange*="${id}"]`)) {
                    item.classList.add('removing');
                }
            });

            try {
                const res = await fetch('/api/todos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'delete', id })
                });
                const data = await res.json();

                // Wait for animation before re-rendering
                setTimeout(() => {
                    renderTodos(data.todos);
                }, 300);
            } catch (err) {
                console.error(err);
                fetchTodos(); // Revert on error
            }
        }

        // Initialize Everything
        document.addEventListener('DOMContentLoaded', function() {
            updateAcademicChart();
            initStudyChart();
            fetchTodos();

            // Form submission for new todo
            document.getElementById('newTodoInput').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    addTodo();
                }
            });
        });
    </script>

    <!-- Notification System -->
    {% include 'notifications_snippet.html' %}
</body>
</html>
