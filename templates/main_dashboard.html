<!DOCTYPE html>
<html lang="en" data-theme="{{ settings.get('theme', 'dark') }}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home — Sclera</title>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="dashboard-layout">
        <!-- TOPNAV -->
        {% include '_topnav.html' %}

        <!-- MAIN -->
        <main class="main-content">
            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            {% for category, message in messages %}
            <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
            {% endif %}
            {% endwith %}

            <div class="dashboard-grid">

                <!-- 1. COMPACT ACADEMIC ISLAND -->
                <a href="{{ url_for('academic_dashboard') }}" class="island island-academic" style="text-decoration:none;">
                    <h3>Academic</h3>
                    <p>Syllabus &amp; Progress</p>
                    <div class="academic-content">
                        <div class="island-chart">
                            <canvas id="academicDonut"></canvas>
                            <div class="chart-center-text" style="font-size: 18px;">{{ overall_progress }}%</div>
                        </div>
                        <div class="academic-legend" style="gap: 8px;">
                            <div class="legend-item">
                                <span class="legend-label" style="font-size: 12px;">Done:</span>
                                <span class="legend-value" style="font-size: 20px;">{{ completed_chapters }}</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-label" style="font-size: 12px;">Total:</span>
                                <span class="legend-value" style="font-size: 20px;">{{ total_chapters }}</span>
                            </div>
                        </div>
                    </div>
                </a>

                <!-- 2. STREAK ISLAND -->
                <div class="island streak-island">
                    <div class="streak-icon">
                        <span class="material-symbols-outlined" style="font-size: 48px;">local_fire_department</span>
                    </div>
                    <div class="streak-info">
                        <h4>Daily Streak</h4>
                        <div class="streak-val">{{ streak }} Days</div>
                    </div>
                </div>

                <!-- 3. PROFILE ISLAND (Compact) -->
                <a href="{{ url_for('profile_resume') }}" class="island" style="text-decoration:none;">
                    <h3>Profile</h3>
                    <div style="display: flex; align-items: center; gap: 12px; margin-top: 10px;">
                        {% if profile_picture %}
                        <img src="{{ url_for('serve_profile_picture', filename=profile_picture.split('/')[1]) }}" alt="PFP" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover;">
                        {% else %}
                        <div style="width: 50px; height: 50px; border-radius: 50%; background: var(--bg-tertiary); display: flex; align-items: center; justify-content: center;">
                            <span class="material-symbols-outlined">person</span>
                        </div>
                        {% endif %}
                        <div>
                            <p style="margin:0; font-weight: 600; color: var(--text-primary);">{{ name }}</p>
                            <p style="margin:0; font-size: 12px;">{{ purpose_display }}</p>
                        </div>
                    </div>
                </a>

                <!-- 4. CALENDAR WIDGET ISLAND -->
                <a href="{{ url_for('calendar_dashboard') }}" class="island island-calendar-widget" style="text-decoration:none;">
                    <h3>Calendar</h3>
                    <p>Upcoming Deadlines</p>
                    <div class="mini-calendar-events">
                        {% set recent_events = calendar_events | sort(attribute='start') %}
                        {% for event in recent_events[:5] %}
                        <div class="mini-event-item">
                            <div class="mini-event-dot dot-{{ event.type }}"></div>
                            <div style="flex:1;">
                                <div style="font-weight: 500; color: var(--text-primary);">{{ event.title }}</div>
                                <div style="font-size: 11px; color: var(--text-muted);">{{ event.start }}</div>
                            </div>
                            {% if event.completed %}
                            <span class="material-symbols-outlined" style="font-size: 16px; color: var(--success);">check_circle</span>
                            {% endif %}
                        </div>
                        {% else %}
                        <p style="text-align: center; padding: 20px 0;">No upcoming events</p>
                        {% endfor %}
                    </div>
                    <span style="font-size: 12px; color: var(--accent); margin-top: auto; padding-top: 12px;">View full calendar →</span>
                </a>

                <!-- 5. PERFORMANCE ISLAND -->
                <div class="island">
                    <h3>Performance</h3>
                    <div class="performance-metrics">
                        <div class="perf-item">
                            <div style="display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 4px;">
                                <span>Average Score</span>
                                <span>{{ avg_performance }}%</span>
                            </div>
                            <div class="perf-bar-container">
                                <div class="perf-bar-fill" style="width: {{ avg_performance }}%; background: #3b82f6;"></div>
                            </div>
                        </div>

                        <div class="perf-item">
                            <div style="display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 4px;">
                                <span>Last Exam</span>
                                <span>{{ last_exam.pct if last_exam else 0 }}%</span>
                            </div>
                            <div class="perf-bar-container">
                                <div class="perf-bar-fill" style="width: {{ last_exam.pct if last_exam else 0 }}%; background: #22c55e;"></div>
                            </div>
                            {% if last_exam %}
                            <div style="font-size: 10px; color: var(--text-muted); margin-top: 2px;">{{ last_exam.subject }}</div>
                            {% endif %}
                        </div>

                        <div class="perf-item">
                            <div style="display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 4px;">
                                <span>Highest Score</span>
                                <span>{{ highest_exam.pct if highest_exam else 0 }}%</span>
                            </div>
                            <div class="perf-bar-container">
                                <div class="perf-bar-fill" style="width: {{ highest_exam.pct if highest_exam else 0 }}%; background: #a855f7;"></div>
                            </div>
                            {% if highest_exam %}
                            <div style="font-size: 10px; color: var(--text-muted); margin-top: 2px;">{{ highest_exam.subject }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- 6. STATS ISLAND -->
                <div class="island">
                    <h3>Completion Stats</h3>
                    <div class="stats-island-grid">
                        <div class="stat-box-small">
                            <span class="val">{{ completed_goals }}/{{ total_goals }}</span>
                            <span class="lab">Goals</span>
                        </div>
                        <div class="stat-box-small">
                            <span class="val">{{ completed_tasks }}/{{ total_tasks }}</span>
                            <span class="lab">Tasks</span>
                        </div>
                        <div class="stat-box-small">
                            <span class="val">{{ completed_assignments }}/{{ total_assignments }}</span>
                            <span class="lab">Assignments</span>
                        </div>
                        <div class="stat-box-small">
                            <span class="val">{{ completed_chapters }}</span>
                            <span class="lab">Chapters</span>
                        </div>
                    </div>
                </div>

                <!-- 7. STUDY TIME GRAPH -->
                <div class="island" style="grid-column: span 2;">
                    <h3>Study Time (Last 7 Days)</h3>
                    <div style="height: 200px; margin-top: 10px;">
                        <canvas id="studyTimeChart"></canvas>
                    </div>
                </div>

                <!-- 8. QUICK TODO ISLAND -->
                <div class="island">
                    <h3>Quick Access TODO</h3>
                    <div class="quick-todo-container">
                        <div class="todo-input-row">
                            <input type="text" id="newTodoInput" placeholder="New task...">
                            <button class="btn btn-secondary" onclick="addTodo()" style="padding: 0 12px;">+</button>
                        </div>
                        <div class="mini-todo-list" id="todoList">
                            <!-- JS populated -->
                        </div>
                    </div>
                </div>

            </div>

        </main>
    </div>

    <script>
        // ACADEMIC DONUT
        let academicChart = null;
        function updateAcademicChart() {
            const canvas = document.getElementById('academicDonut');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const progress = {{ overall_progress }};
            const rootStyles = getComputedStyle(document.documentElement);
            const progressFill = rootStyles.getPropertyValue('--progress-fill').trim() || '#ffffff';
            const progressTrack = rootStyles.getPropertyValue('--progress-track').trim() || '#27272a';
            
            if (academicChart) academicChart.destroy();
            academicChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [progress, Math.max(1, 100 - progress)],
                        backgroundColor: [progressFill, progressTrack],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '80%',
                    plugins: { legend: { display: false }, tooltip: { enabled: false } }
                }
            });
        }

        // STUDY TIME CHART
        function initStudyChart() {
            const ctx = document.getElementById('studyTimeChart').getContext('2d');
            const data = {{ study_stats | tojson | safe }};

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.day),
                    datasets: [{
                        label: 'Hours Studied',
                        data: data.map(d => d.hours),
                        backgroundColor: '#3b82f6',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } },
                        x: { grid: { display: false } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // QUICK TODO LOGIC
        async function fetchTodos() {
            const res = await fetch('/api/todos');
            const todos = await res.json();
            renderTodos(todos);
        }

        function renderTodos(todos) {
            const list = document.getElementById('todoList');
            list.innerHTML = '';
            todos.forEach(todo => {
                const div = document.createElement('div');
                div.className = `mini-todo-item ${todo.completed ? 'done' : ''}`;
                div.innerHTML = `
                    <input type="checkbox" ${todo.completed ? 'checked' : ''} onchange="toggleTodo('${todo.id}')">
                    <span>${todo.text}</span>
                    <span class="material-symbols-outlined" style="font-size: 16px; cursor: pointer; color: var(--text-muted);" onclick="deleteTodo('${todo.id}')">delete</span>
                `;
                list.appendChild(div);
            });
        }

        async function addTodo() {
            const input = document.getElementById('newTodoInput');
            const text = input.value.trim();
            if (!text) return;
            const res = await fetch('/api/todos', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'add', text })
            });
            const data = await res.json();
            input.value = '';
            renderTodos(data.todos);
        }

        async function toggleTodo(id) {
            const res = await fetch('/api/todos', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'toggle', id })
            });
            const data = await res.json();
            renderTodos(data.todos);
        }

        async function deleteTodo(id) {
            const res = await fetch('/api/todos', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'delete', id })
            });
            const data = await res.json();
            renderTodos(data.todos);
        }

        document.addEventListener('DOMContentLoaded', function() {
            updateAcademicChart();
            initStudyChart();
            fetchTodos();
        });
    </script>

    <!-- Notification System -->
    {% include 'notifications_snippet.html' %}
</body>
</html>
