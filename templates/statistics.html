<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <title>Statistics</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .chart-container {
            position: relative;
            width: 100%;
            min-height: 200px;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px 0;
        }
        canvas {
            display: block;
            max-width: 100%;
            max-height: 100%;
        }
        .chart-wrapper {
            position: relative;
            height: 300px;
            margin: 20px 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .study-island {
            display: flex;
            flex-direction: column;
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 20px;
            min-height: 200px;
        }
    </style>
</head>

<body>
    {% block content %}

    <div class="dashboard-layout-statistics">
        <!-- SIDEBAR -->
        {% include '_sidebar.html' %}


        <main class="main-content">
            <h2>Statistics</h2>
            <!-- Grid Container for Statistics -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-top: 24px;">

                <!-- 1. Daily Streak -->
                <div class="study-island"
                    style="display: flex; flex-direction: column; justify-content: center; min-height: 200px;">
                    <h3>Daily Streak</h3>
                    <div class="streak-box"
                        style="font-size: 3em; font-weight: 700; margin-top: 10px; color: var(--accent);">{{ streak }}
                        Days</div>
                </div>

                <!-- 2. Productivity Overview -->
                <div class="study-island"
                    style="display: flex; flex-direction: column; justify-content: center; min-height: 200px;">
                    <h3>Productivity Overview</h3>
                    <div class="productivity-container"
                        style="display:flex; flex-direction: column; gap:16px; margin-top:15px;">
                        <!-- Goals -->
                        <div>
                            <div style="display:flex; justify-content:space-between; margin-bottom:6px;">
                                <span style="font-weight:600; font-size:14px;">Goals</span>
                                <span style="color:var(--text-muted); font-size:13px;">{{ productivity.goals.completed
                                    }}/{{ productivity.goals.total }}</span>
                            </div>
                            <div class="progress-bar-track"
                                style="height:10px; border-radius:5px; background:var(--bg-tertiary);">
                                <div class="progress-bar-fill"
                                    style="width:{{ productivity.goals.pct }}%; background:var(--tick-color); border-radius:5px;">
                                </div>
                            </div>
                        </div>

                        <!-- Tasks -->
                        <div>
                            <div style="display:flex; justify-content:space-between; margin-bottom:6px;">
                                <span style="font-weight:600; font-size:14px;">Tasks</span>
                                <span style="color:var(--text-muted); font-size:13px;">{{ productivity.tasks.completed
                                    }}/{{ productivity.tasks.total }}</span>
                            </div>
                            <div class="progress-bar-track"
                                style="height:10px; border-radius:5px; background:var(--bg-tertiary);">
                                <div class="progress-bar-fill"
                                    style="width:{{ productivity.tasks.pct }}%; background:var(--tick-color); border-radius:5px;">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 3. Exam Performance (Average) - BIGGER -->
                <div class="study-island" style="min-height: 400px; display:flex; flex-direction:column;">
                    <h3>Exam Performance (Average)</h3>
                    <div style="flex:1; position: relative; min-height: 300px;">
                        <canvas id="barChart"></canvas>
                    </div>
                </div>

                <!-- 4. Exam Progress Over Time - BIGGER -->
                <div class="study-island" style="min-height: 400px; display:flex; flex-direction:column;">
                    <h3>Exam Progress (Overall)</h3>
                    <div style="flex:1; position: relative; min-height: 300px;">
                        <canvas id="lineChart"></canvas>
                    </div>
                </div>

                <!-- 5. Subject Analytics (Spans Full Width) - LARGEST -->
                <div class="study-island" style="grid-column: 1 / -1; min-height: 500px; display:flex; flex-direction:column;">
                    <div class="study-island-header" style="margin-bottom: 20px;">
                        <h3>Subject-wise Performance</h3>
                        <select id="subjectSelect"
                            style="padding:8px 12px; border-radius:6px; border:1px solid var(--border); background:var(--bg-tertiary); color:var(--text-primary); font-size:14px;">
                            {% for subj in subjects %}
                            <option value="{{ subj }}">{{ subj }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="subjectChart"></canvas>
                    </div>
                    {% if not subjects %}
                    <p style="text-align:center; padding:40px; color:var(--text-muted); font-size: 16px;">No subject
                        data available yet. Add exam results to see analytics.</p>
                    {% endif %}
                </div>

            </div>

        </main>
    </div>
</body>

</body>

<script>
    // Simple chart initialization
    document.addEventListener('DOMContentLoaded', function() {
        // Data from server
        const examAvgData = JSON.parse('{{ exam_avg | tojson | safe }}');
        const timelineData = JSON.parse('{{ timeline | tojson | safe }}');
        const subjectPerformance = JSON.parse('{{ subject_performance | tojson | safe }}');
        
        // Bar Chart
        const barCtx = document.getElementById('barChart');
        if (barCtx) {
            const barLabels = Object.keys(examAvgData);
            const barData = Object.values(examAvgData);
            
            new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: barLabels,
                    datasets: [{
                        label: "Average %",
                        data: barData,
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true, max: 100 }
                    }
                }
            });
        }

        // Line Chart - Exam Progress Over Time
        const lineCtx = document.getElementById('lineChart');
        if (lineCtx) {
            const labels = timelineData.map(d => d.date);
            const data = timelineData.map(d => d.percentage);
            
            new Chart(lineCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Exam Progress %',
                        data: data,
                        borderColor: 'rgba(153, 102, 255, 1)',
                        backgroundColor: 'rgba(153, 102, 255, 0.2)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true, max: 100 }
                    }
                }
            });
        }

        // Subject Chart
        const subjectSelect = document.getElementById('subjectSelect');
        const subjectCtx = document.getElementById('subjectChart');
        
        function updateSubjectChart() {
            if (!subjectSelect || !subjectCtx) return;
            
            const subjectName = subjectSelect.value;
            const dataPoints = subjectPerformance[subjectName] || [];
            const labels = dataPoints.map(d => d.date);
            const values = dataPoints.map(d => d.percentage);

            // Destroy existing chart if it exists
            if (window.subjectChart && typeof window.subjectChart.destroy === 'function') {
                window.subjectChart.destroy();
            }

            window.subjectChart = new Chart(subjectCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: subjectName + ' Performance (%)',
                        data: values,
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, max: 100 }
                    }
                }
            });
        }

        // Initial render and event listener
        if (subjectSelect && subjectCtx) {
            updateSubjectChart();
            subjectSelect.addEventListener('change', updateSubjectChart);
        }
    });
</script>

</html>

{% endblock %}
